// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`loadIntermOrg should call sequelize.query with correct SQL and parameters 1`] = `
[MockFunction] {
  "calls": [
    [
      "
  WITH newdata AS (
    SELECT
      O.sbi,
      A."businessAddress1" AS "addressLine1",
      A."businessAddress2" AS "addressLine2",
      A."businessAddress3" AS "addressLine3",
      A."businessCity" AS city,
      A."businessCounty" AS county,
      A."businessPostCode" AS postcode,
      A."businessEmailAddr" AS emailaddress,
      A.frn,
      A."businessName" AS name,
      O."lastUpdatedOn"::date AS updated,
      O."partyId",
      O."changeType"
    FROM public."etlStageOrganisation" O
    LEFT JOIN public."etlStageBusinessAddressContactV" A ON A.sbi = O.sbi
    WHERE O."etlId" BETWEEN 1 AND 2
      
  ),
  updatedrows AS (
    UPDATE public."etlIntermOrg" interm
    SET
      "addressLine1" = newdata."addressLine1",
      "addressLine2" = newdata."addressLine2",
      "addressLine3" = newdata."addressLine3",
      city = newdata.city,
      county = newdata.county,
      postcode = newdata.postcode,
      emailaddress = newdata.emailaddress,
      frn = newdata.frn,
      sbi = newdata.sbi,
      "name" = newdata.name,
      updated = newdata.updated,
      "etlInsertedDt" = NOW()
    FROM newdata
    WHERE newdata."changeType" = 'UPDATE'
      AND interm."partyId" = newdata."partyId"
    RETURNING interm."partyId"
  )
  INSERT INTO public."etlIntermOrg" (
    sbi,
    "addressLine1",
    "addressLine2",
    "addressLine3",
    city,
    county,
    postcode,
    emailaddress,
    frn,
    "name",
    "partyId",
    updated
  )
  SELECT
    sbi,
    "addressLine1",
    "addressLine2",
    "addressLine3",
    city,
    county,
    postcode,
    emailaddress,
    frn,
    "name",
    "partyId",
    updated
  FROM newdata
  WHERE "changeType" = 'INSERT'
    OR ("changeType" = 'UPDATE' AND "partyId" NOT IN (SELECT "partyId" FROM updatedrows));
",
      {
        "raw": true,
        "replacements": {},
        "transaction": undefined,
      },
    ],
    [
      "
  WITH newdata AS (
    SELECT
      O.sbi,
      A."businessAddress1" AS "addressLine1",
      A."businessAddress2" AS "addressLine2",
      A."businessAddress3" AS "addressLine3",
      A."businessCity" AS city,
      A."businessCounty" AS county,
      A."businessPostCode" AS postcode,
      A."businessEmailAddr" AS emailaddress,
      A.frn,
      A."businessName" AS name,
      O."lastUpdatedOn"::date AS updated,
      O."partyId",
      O."changeType"
    FROM public."etlStageOrganisation" O
    LEFT JOIN public."etlStageBusinessAddressContactV" A ON A.sbi = O.sbi
    WHERE O."etlId" BETWEEN 1 AND 2
       AND O."etlId" NOT BETWEEN 1 AND 2
  ),
  updatedrows AS (
    UPDATE public."etlIntermOrg" interm
    SET
      "addressLine1" = newdata."addressLine1",
      "addressLine2" = newdata."addressLine2",
      "addressLine3" = newdata."addressLine3",
      city = newdata.city,
      county = newdata.county,
      postcode = newdata.postcode,
      emailaddress = newdata.emailaddress,
      frn = newdata.frn,
      sbi = newdata.sbi,
      "name" = newdata.name,
      updated = newdata.updated,
      "etlInsertedDt" = NOW()
    FROM newdata
    WHERE newdata."changeType" = 'UPDATE'
      AND interm."partyId" = newdata."partyId"
    RETURNING interm."partyId"
  )
  INSERT INTO public."etlIntermOrg" (
    sbi,
    "addressLine1",
    "addressLine2",
    "addressLine3",
    city,
    county,
    postcode,
    emailaddress,
    frn,
    "name",
    "partyId",
    updated
  )
  SELECT
    sbi,
    "addressLine1",
    "addressLine2",
    "addressLine3",
    city,
    county,
    postcode,
    emailaddress,
    frn,
    "name",
    "partyId",
    updated
  FROM newdata
  WHERE "changeType" = 'INSERT'
    OR ("changeType" = 'UPDATE' AND "partyId" NOT IN (SELECT "partyId" FROM updatedrows));
",
      {
        "raw": true,
        "replacements": {},
        "transaction": undefined,
      },
    ],
  ],
  "results": [
    {
      "type": "return",
      "value": undefined,
    },
    {
      "type": "return",
      "value": undefined,
    },
  ],
}
`;
